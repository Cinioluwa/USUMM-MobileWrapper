<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/feed_card_css.css">
    <link rel="stylesheet" href="../static/style.css">
    <title>USUMM</title>
</head>
<body>
    <div class="nav">
        <h1><a href="/">USUMM</a></h1>
        <form action="/search" method="GET">
            <input type="text" name="q" placeholder="Search YouTube..." required>
            <button type="submit">Search</button>
        </form>
        <p><a class="a" href="/logout">Logout</a></p>
            <button id="downloadFeedBtn" style="margin-left:10px;">Download Feed</button>
    </div>

        

    
    <div class="feed-container">
       
        {% for video in videos%}
        <a href="/summarize/{{video.video_id}}">
        <article class="feed-card">
            <div class="feed-card__author">
            <img src="{{video.channel_avatar}}" alt="Jan Kammerath" class="feed-card__avatar">
            <span class="feed-card__author-name">{{video.channelTitle}}</span>
            </div>
            
            <div class="feed-card__content">
            <div class="feed-card__text">
                <h2 class="feed-card__title">{{video.title}}</h2>
                <p class="feed-card__description">{{video.description[0:100]}}...</p>
            </div>
            <img src="{{video.thumbnail}}" alt="" class="feed-card__image">
            </div>
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/static/service-worker.js')
            .then(function(registration) {
                console.log('ServiceWorker registration successful:', registration.scope);
            }, function(err) {
                console.log('ServiceWorker registration failed:', err);
            });
    });
}
</script>
            
            <div class="feed-card__meta">
            <!-- <span class="feed-card__highlight">‚òÖ</span> -->
            <span class="feed-card__timestamp">{{video.published_at[:10]}}</span>
            <div class="feed-card__stat">
                <span>üëè</span>
                <span>{{video.like_count}}</span>
            </div>
            <div class="feed-card__stat">
                <span>üí¨</span>
                <span>{{video.comment_count}}</span>
            </div>
            </div>
        </article>
        </a>
        {% endfor %}

    </div>
</body>

<script>
    document.getElementById('downloadFeedBtn').onclick = async function() {
        try {
            const res = await fetch('/download_feed');
            if (!res.ok) throw new Error('Failed to fetch feed');
            const data = await res.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'usumm_feed.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            alert('Error downloading feed: ' + e.message);
        }
    }
</script>
</html>